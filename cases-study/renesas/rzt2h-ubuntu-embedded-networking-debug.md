
# Ubuntu Embedded Networking 除錯報告（RZ/T2H）


## 1. 問題描述

在 RZ/T2H 平台啟動 Ubuntu rootfs 後，出現以下問題：

-   `ifconfig` 顯示已有 IPv4 位址
    
-   `ip route` 看似存在 default route
    
-   有時可 ping gateway
    
-   **無法穩定 ping 外部 IP（8.8.8.8）**
    
-   **永遠無法解析網域名稱**
    
-   重開機後網路行為不一致
    

常見現象如下：

```bash
ping 8.8.8.8        ❌ 不穩定
ping www.google.com ❌ 一定失敗
```

----------

## 2. 問題發生時的網路狀態

### 網卡資訊

```bash
eth0: 10.20.70.124/23
```

### Routing table（異常）

```bash
0.0.0.0 dev eth0 scope link

default dev eth0 scope link        ❌
default via 10.20.70.254 dev eth0  ✅

169.254.0.0/16 dev eth0            ❌

```

上述 routing table 對於正常上網而言是 **錯誤狀態**。

----------

## 3. 問題真正原因（多重因素）

此問題並非單一 bug，而是 **多個 network manager 同時啟動所造成的競爭問題**。

### 系統中同時存在：

| 元件                 | 狀態         |
|----------------------|--------------|
| NetworkManager       | running      |
| connman              | running      |
| avahi-daemon         | running      |
| systemd-resolved     | 部分停用     |
| udhcpc               | 已安裝       |


以上元件同時操作：

-   routing table
    
-   default gateway
    
-   DNS
    

導致網路狀態無法穩定。

----------

## 4. 關鍵證據分析

### 4.1 connman 主動修改 routing

systemd log 中可觀察到：

```
connmand: eth1 {add} route 0.0.0.0 gw 0.0.0.0
```

實際效果為：

```bash
default dev eth1
```

此 routing 代表：

> 所有目的地都直接以 ARP 嘗試送出

結果：

-   不經 gateway
    
-   外部網路永遠無法連線
    

----------

### 4.2 avahi 啟用 IPv4 Link-Local

avahi-daemon 會自動啟用：

```bash
169.254.x.x/16
```

導致：

-   kernel routing table 被污染
    
-   link up / down 時反覆新增與刪除 route
    

----------

### 4.3 DNS 被 connman 接管

`/etc/resolv.conf` 內容為：

```conf
# Generated by Connection Manager
nameserver 127.0.0.1
nameserver ::1
```

但系統中：

-   並無本地 DNS proxy
    
-   systemd-resolved 已停用
    

因此所有 DNS 查詢全部失敗：

```bash
Temporary failure in name resolution
```

----------

## 5. 為何手動修正無法持久

即使手動執行：

```bash
ip route del default dev eth0
echo "nameserver 8.8.8.8" > /etc/resolv.conf
```

僅在當次有效，重開機後會再次失效，原因為：

-   connman 開機後重新插入 routing
    
-   avahi 重新啟用 IPv4LL
    
-   resolv.conf 被再次覆寫
    

----------

## 6. 關鍵發現：rootfs build 與 runtime 的差異

在 rootfs 建置階段確認：

```bash
/etc/systemd/system/connman.service -> /dev/null
```

但實際板子上卻顯示：

```bash
Loaded: loaded (/usr/lib/systemd/system/connman.service)
```

此現象證實：

> **板子實際 boot 的 rootfs 並非最新建置版本。**

重新燒錄 rootfs 後，systemd override 才真正生效。

----------

## 7. 最終解法策略

### 設計原則

> **系統中只能存在一套網路管理機制。**

最終採用架構：

```
Kernel Ethernet Driver
        ↓
NetworkManager
        ↓
DHCP + Routing
        ↓
Static DNS (/etc/resolv.conf)
```

完全移除：

-   connman
    
-   avahi
    
-   systemd-resolved
    

----------

## 8. 最終實作方式（rootfs 階段）

### 8.1 移除衝突套件

```bash
apt-get -y purge connman connman-client
apt-get -y purge avahi-daemon avahi-autoipd
apt-get -y autoremove --purge
```

----------

### 8.2 防止被相依套件拉回

```bash
apt-mark hold connman connman-client avahi-daemon avahi-autoipd
```

----------

### 8.3 systemd 最底層 hard mask

```bash
mkdir -p /etc/systemd/system

ln -sf /dev/null /etc/systemd/system/connman.service
ln -sf /dev/null /etc/systemd/system/connman.socket

ln -sf /dev/null /etc/systemd/system/avahi-daemon.service
ln -sf /dev/null /etc/systemd/system/avahi-daemon.socket
```

此方式即使在 chroot 環境中也一定生效。

----------

### 8.4 關閉 systemd-resolved

```bash
systemctl stop systemd-resolved.service || true
systemctl disable systemd-resolved.service || true
systemctl mask systemd-resolved.service || true
```

----------

### 8.5 固定 DNS 設定

```conf
# /etc/resolv.conf
nameserver 8.8.8.8
nameserver 1.1.1.1
```

並禁止 NetworkManager 改寫 DNS：

```ini
# /etc/NetworkManager/conf.d/99-no-dns.conf
[main]
dns=none
```

----------

## 9. 最終系統狀態

### Routing

```bash
default via 10.20.70.254 dev eth0
10.20.70.0/23 dev eth0
```

### Service 狀態

```bash
systemctl status connman
Loaded: masked (/dev/null)

systemctl status avahi-daemon
Loaded: masked (/dev/null)
```

### 網路驗證

```bash
ping 10.20.70.254   ✅
ping 8.8.8.8        ✅
ping www.google.com ✅
```

----------

## 10. 重要經驗整理

### 1️⃣ Network manager 只能選一個

以下不可共存：

-   connman
    
-   NetworkManager
    
-   systemd-networkd
    
-   udhcpc
    

----------

### 2️⃣ `default dev ethX` 是致命 routing

此 routing 會導致 kernel 對所有 IP 直接 ARP，外網一定失敗。

----------

### 3️⃣ rootfs 階段 systemctl 並不可靠

-   `systemctl disable` 在 chroot 常失效
    
-   `/etc/systemd/system/*.service -> /dev/null` 才是真正的 mask
    

----------

### 4️⃣ DNS 問題 ≠ 網路問題

若出現：

```bash
ping 8.8.8.8 OK
ping domain FAIL
```

代表 DNS stack 有問題，而非 Ethernet driver。

----------

## 11. 最終架構圖

```
+---------------------+
| Ethernet Driver     |
+---------------------+
            ↓
+---------------------+
| NetworkManager      |
|  - DHCP             |
|  - routing           |
+---------------------+
            ↓
+---------------------+
| /etc/resolv.conf    |
| static DNS           |
+---------------------+

(connman ✘ avahi ✘ resolved ✘)
```

