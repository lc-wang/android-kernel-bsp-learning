
# Android Process Runtime Modelï¼ˆProcess / Thread / OOM / cgroup çš„ç³»çµ±è¦–è§’ï¼‰

> æœ¬ç« å®šä½ï¼š
> 
> -   ç”¨ **Android System Engineer** çš„è¦–è§’ï¼ŒæŠŠã€Œprocess å¾å“ªä¾†ã€æ€éº¼è¢«ç®¡ç†ã€æ€éº¼è¢«æ®ºã€è³‡æºæ€éº¼è¢«åˆ†é…ã€ä¸²æˆä¸€å¼µå¯ debug çš„æ¨¡å‹
>     
----------

## 1. ç‚ºä»€éº¼éœ€è¦ã€ŒProcess Runtime Modelã€é€™ä¸€ç« 

å¯ä»¥æŠŠ Android æƒ³æˆï¼š

-   Linux çš„ process/thread ç•¶åº•åº§
-   ä¸Šé¢ç–Šäº†ä¸€å€‹ã€Œç³»çµ±ç”¨æˆ¶æ…‹è³‡æºç®¡ç†å±¤ã€
    

å¾ˆå¤šå•é¡Œï¼ˆå¡é “ / è¢«æ®º / çœé›»éé ­ï¼‰éƒ½ä¸æ˜¯å–®é» bugï¼Œè€Œæ˜¯æ¨¡å‹çš„çµæœï¼š

-   AMS æ±ºå®šã€Œèª°é‡è¦ã€
-   LMKD æ±ºå®šã€Œèª°å…ˆæ­»ã€
-   cgroup æ±ºå®šã€Œèª°æ‹¿å¾—åˆ° CPU / memoryã€
-   scheduler æ±ºå®šã€Œèª°çœŸçš„è·‘åˆ° CPUã€

ğŸ‘‰ æ²’æœ‰æ©«å‘æ¨¡å‹ï¼Œä½ åªèƒ½åœ¨ log è£¡ç›²çŒœã€‚

----------

## 2. Android Process å¾å“ªè£¡ä¾†ï¼šZygote â†’ app_process

### 2.1 Zygote çš„è§’è‰²ï¼ˆä¸æ˜¯æ™®é€š daemonï¼‰

Zygote æ˜¯ï¼š

-   é å…ˆè¼‰å…¥ framework class / resources
-   æä¾› fork ä»‹é¢
-   è®“æ–° app é€²ç¨‹å¿«é€Ÿå•Ÿå‹•
    

å› æ­¤ Android app çš„å»ºç«‹ä¸æ˜¯ `execve()` ä¸»å°ï¼Œè€Œæ˜¯ï¼š

system_server(AMS) â†’ Zygote fork â†’ app process

é—œéµå«æ„ï¼š

-   å¤§é‡è¨˜æ†¶é«”æ˜¯ sharedï¼ˆCOWï¼‰
-   process startup çš„ç“¶é ¸å¾€å¾€ä¸æ˜¯ kernel

----------

### 2.2 spawn çš„è§€å¯Ÿé»

åœ¨ debug app å•Ÿå‹•æ…¢æ™‚ï¼Œä¸è¦åªç›¯ ActivityThreadã€‚

è¦èƒ½å›ç­”ï¼š

-   fork æœ‰æ²’æœ‰å¡ï¼Ÿ
-   preload æ˜¯å¦éé‡ï¼Ÿ
-   æ˜¯å¦è¢« CPU cgroup å£“ä½ï¼Ÿ
    

----------

## 3. system_serverï¼šAndroid è³‡æºç®¡ç†çš„ä¸­æ¨

system_server å…§å«ï¼š

-   ActivityManagerServiceï¼ˆAMSï¼‰
-   WindowManagerServiceï¼ˆWMSï¼‰
-   PackageManagerServiceï¼ˆPMSï¼‰
-   ä»¥åŠå¤§é‡ system services
    

åœ¨ process runtime çš„è§’åº¦ï¼š

-   AMS è² è²¬ process çš„ã€Œé‡è¦æ€§ã€èˆ‡ç”Ÿå‘½é€±æœŸ
-   WMS å½±éŸ¿å‰æ™¯äº’å‹•èˆ‡å¯è¦–ç‹€æ…‹
    
ğŸ‘‰ AMS / WMS æ˜¯åŒä¸€å€‹ runtime æ¨¡å‹çš„å…©å´ã€‚

----------

## 4. ProcessRecord / UID / Taskï¼šAndroid ç”¨æˆ¶æ…‹çš„ process metadata

### 4.1 ProcessRecordï¼ˆAMS è¦–è§’ï¼‰

AMS æœƒç‚ºæ¯å€‹é€²ç¨‹ç¶­è­· ProcessRecordï¼ŒåŒ…æ‹¬ï¼š

-   uid
-   processName
-   importance
-   oomAdj
    
é€™äº› metadata æœƒé©…å‹•å¾ŒçºŒè¡Œç‚ºï¼š

-   cgroup åˆ†é…
-   OOM å„ªå…ˆé †åº

----------

### 4.2 UID æ˜¯è³‡æºèˆ‡å®‰å…¨çš„æ ¸å¿ƒåˆ‡é¢

Android ä»¥ UID ç‚ºä¸­å¿ƒä¾†åšï¼š

-   æ¬Šé™éš”é›¢
-   è³‡æºçµ±è¨ˆ
-   cgroup åˆ†çµ„
    
ğŸ‘‰  debug æ™‚è¦ç¿’æ…£ç”¨ uid ä¾†è¿½å•é¡Œã€‚

----------

## 5. OOM æ¨¡å‹ï¼šå¾ã€Œé‡è¦æ€§ã€åˆ°ã€Œå¯è¢«æ®ºã€

### 5.1 OOM Adj çš„æ„ç¾©

Android ä¸ç›´æ¥ä¾è³´ Linux OOM killer çš„ç›´è¦ºæ’åºã€‚

å®ƒåœ¨ userspace è‡ªå·±ç®—å‡ºï¼š

-   å‰æ™¯ app
-   service
-   cached
    
å†æ˜ å°„æˆï¼š

-   `oom_score_adj`
    
----------

### 5.2 LMKDï¼ˆLow Memory Killer Daemonï¼‰

ç¾ä»£ Android å¤šç”± LMKD ä¾†ä¸»å‹•æ±ºç­–ï¼š

-   ç›£æ¸¬ memory pressure
-   ä¾ oom_score_adj æ±ºå®šæ®ºèª°
    

LMKD çš„ä½œç”¨æ˜¯ï¼š
-   åœ¨ kernel OOM killer ä»‹å…¥å‰å°±æ”¶æ–‚
    
----------

## 6. cgroup / schedulerï¼šèª°ã€Œé‡è¦ã€ä¸ä»£è¡¨èª°ã€Œè·‘å¾—å‹•ã€

### 6.1 CPU cgroupï¼šåˆ†é…æ™‚é–“ç‰‡çš„å®¹å™¨

Android æœƒæŠŠä¸åŒé¡å‹çš„ thread æ”¾é€²ä¸åŒç¾¤çµ„ï¼Œä¾‹å¦‚ï¼š

-   top-app 
-   foreground
-   background
    

é€™æœƒå½±éŸ¿ï¼š

-   scheduler çš„æŒ‘é¸
-   latency

----------

### 6.2 Thread priority èˆ‡ group çš„äº¤äº’

å¸¸è¦‹èª¤åˆ¤ï¼š

-   èª¿æ•´ thread priority å°±èƒ½æ”¹å–„å¡é “
    
å¯¦å‹™ä¸Šï¼š

-   priority åªåœ¨åŒ group å…§æœ‰æ•ˆ
-   group æ±ºå®šä½ èƒ½ä¸èƒ½æ‹¿åˆ° CPU
    
ğŸ‘‰ debug jank æ™‚ï¼Œè¦å…ˆçœ‹ä½ åœ¨ä»€éº¼ groupã€‚

----------

## 7. å¸¸è¦‹å•é¡Œçš„å¿«é€Ÿæ¨¡å‹å®šä½

### 7.1 App è¢«æ®ºï¼ˆæ˜æ˜ RAM çœ‹èµ·ä¾†é‚„æœ‰ï¼‰

å¯èƒ½åŸå› ï¼š

-   memory pressure ä¾†è‡ªåŒ¿åé  / file cache å›æ”¶å›°é›£
-   LMKD ä¾ adj æ±ºç­–
    

è¦æŸ¥ï¼š

-   `dumpsys meminfo`
-   `lmkd` log
-   `oom_score_adj`

----------

### 7.2 å‰æ™¯æ‰å¹€ / è§¸æ§å¡é “

å¯èƒ½åŸå› ï¼š

-   top-app group æ²’æ‹¿åˆ°è¶³å¤  CPU
-   binder thread pool è¢«å£“ä½
    

è¦æŸ¥ï¼š

-   scheduler latency
-   cgroup åˆ†é…

----------

### 7.3 èƒŒæ™¯æœå‹™å®¹æ˜“æ­»

å¯èƒ½åŸå› ï¼š

-   importance è¢«é™ç´š
-   cached è¡Œç‚º
    
è¦æŸ¥ï¼š

-   ProcessRecord çš„ state
-   oom adj è®ŠåŒ–

----------

## 8. Debug Toolbox

> é€™è£¡çš„ç›®æ¨™ä¸æ˜¯åˆ—æŒ‡ä»¤ï¼Œè€Œæ˜¯æä¾›ã€Œæœ€å°é–‰ç’°ã€ï¼š ä½ èƒ½ç”¨é€™äº›è¼¸å‡ºæŠŠå•é¡Œå¾çŒœæ¸¬è®Šæˆå¯é©—è­‰ã€‚

### 8.1 è§€å¯Ÿ process / oom
```bash
adb shell ps -A | head

adb shell cat /proc/<pid>/oom_score_adj
```
----------

### 8.2 dumpsysï¼ˆAMS / memoryï¼‰
```bash
adb shell dumpsys activity processes

adb shell dumpsys meminfo <package>
```
----------

### 8.3 cgroup åˆ†çµ„
```bash
adb shell cat /proc/<pid>/cgroup

adb shell cat /proc/<pid>/sched
```
----------

### 8.4 è§€å¯Ÿ LMKD è¡Œç‚º
```bash
adb logcat | grep -i lmk
```
----------

## 9. å¸¸è¦‹èª¤åˆ¤èˆ‡ Debug 


| ç¾è±¡             | å¸¸è¦‹èª¤åˆ¤        | çœŸæ­£åŸå›                              |
|------------------|-----------------|--------------------------------------|
| RAM é‚„æœ‰ä½†è¢«æ®º   | Android bug     | Memory pressure / LMKD ç­–ç•¥           |
| ç³»çµ±å¡é “         | App å¯«å¾—çˆ›      | Top-app cgroup / Scheduler latency    |
| èƒŒæ™¯æœå‹™å¸¸è¢«æ®º   | Service bug     | Importance / OOM adj ç­‰ç´šä¸‹é™         |

